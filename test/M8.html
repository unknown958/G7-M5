<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Test M√≥dulo 8</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #f2f4f7; margin:0; }
.container { max-width: 900px; margin:auto; padding:15px; }
.card { background:white; border-radius:10px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
h1,h2,h3{text-align:center;}
.question{font-size:1.1rem;margin-bottom:15px;font-weight:bold;}
.options label{
    display:block;
    padding:12px;
    margin-bottom:12px;
    border-radius:8px;
    border:2px solid #ddd;
    cursor:pointer;
    transition: background 0.2s, border 0.2s;
}
.options label.selected{background:#cce5ff;border-color:#007bff;}
.options label.option-wrong{border-color:#dc3545;background:#f8d7da;}
.options label.option-correct{border-color:#28a745;background:#d4edda;}
button{padding:14px;font-size:1rem;border-radius:8px;border:none;background:#007bff;color:white;width:100%;cursor:pointer;margin-top:15px;}
button.secondary{background:#007bff;}
button.third{background:#dc3545;}
button.cuart{background:#fd7e14;}
.info{display:flex;justify-content:space-between;margin-bottom:10px;font-weight:bold;}
.final{display:none;}
.failed-question{margin-top:30px;padding-top:20px;border-top:1px solid #ddd;}
.failed-question .question-text{margin-bottom:15px;font-weight:bold;}
.saved-module{
    margin:8px 0 20px 0; 
    font-size:0.95rem; 
    padding:10px;
    border-radius:10px;
    box-shadow:0 3px 8px rgba(0,0,0,0.1);
    transition: background 0.3s;
}
.saved-module p{margin:3px 0;}
.saved-module.low{background:#f8d7da; color:#842029;}
.saved-module.mid{background:#fff3cd; color:#664d03;}
.saved-module.high{background:#d1e7dd; color:#0f5132;}
#resumeDialog {
    display: none; 
    position: fixed; 
    top: 0; left: 0; right: 0; bottom: 0; 
    background: rgba(0,0,0,0.5); 
    z-index: 9999;
    justify-content: center; 
    align-items: center;
}
#resumeDialog .card {
    max-width: 400px; 
    background: white;        
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex; 
    flex-direction: column;
    align-items: center;
    gap: 12px; 
    text-align: center;
}
#resumeDialog h2 { margin:0; }
#resumeDialog p { margin:0; font-size:1rem; }
#resumeDialog button { width: 80%; padding: 12px; font-size:1rem; border-radius:8px; border:none; cursor:pointer; transition: background 0.2s; }
#resumeDialog button#continueBtn { background:#28a745; color:white; }
#resumeDialog button#continueBtn:hover { background:#1e7e34; }
#resumeDialog button#newBtn { background:#dc3545; color:white; }
#resumeDialog button#newBtn:hover { background:#a71d2a; }
#resumeDialog button + button { margin-top: 6px; } 
#testSelection { display:none; }
#testButtons button { margin-bottom: 12px; }

/* Eliminamos el toggle switch original del modo estudio/examen */
.mode-toggle-container {
    display: none; /* Ocultamos el toggle original */
}

.mode-label {
    display: none; /* Ocultamos las etiquetas del toggle original */
}

/* Indicador de modo actual */
.current-mode-indicator {
    text-align: center;
    font-weight: bold;
    margin: 10px 0;
    padding: 8px;
    border-radius: 6px;
    background-color: #f8f9fa;
    font-size: 0.9rem;
}

.current-mode-indicator.exam {
    color: #dc3545;
    border: 2px solid #dc3545;
}

.current-mode-indicator.study {
    color: #28a745;
    border: 2px solid #28a745;
}

/* Estilos para mostrar nota en modo estudio */
.study-mode-note {
    background-color: #e7f5ff;
    border-left: 4px solid #007bff;
    padding: 10px;
    margin: 15px 0;
    border-radius: 0 8px 8px 0;
    font-weight: bold;
}

/* Di√°logo de confirmaci√≥n para salir */
#confirmDialog {
    display: none; 
    position: fixed; 
    top: 0; left: 0; right: 0; bottom: 0; 
    background: rgba(0,0,0,0.5); 
    z-index: 9999;
    justify-content: center; 
    align-items: center;
}

#confirmDialog .card {
    max-width: 400px; 
    background: white;        
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex; 
    flex-direction: column;
    align-items: center;
    gap: 12px; 
    text-align: center;
}

#confirmDialog h2 { margin:0; }
#confirmDialog p { margin:0; font-size:1rem; }
#confirmDialog button { width: 80%; padding: 12px; font-size:1rem; border-radius:8px; border:none; cursor:pointer; transition: background 0.2s; }
#confirmDialog button#confirmExitBtn { background:#dc3545; color:white; }
#confirmDialog button#confirmExitBtn:hover { background:#a71d2a; }
#confirmDialog button#cancelExitBtn { background:#6c757d; color:white; }
#confirmDialog button#cancelExitBtn:hover { background:#545b62; }

/* Estilos para los botones del test en la misma l√≠nea */
.button-row {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.button-row button {
    margin-top: 0;
    flex: 1;
}

/* Estilos para los interruptores de modo estudio/examen y modo oscuro */
.mode-toggle-group {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 140px;
    margin: 20px 0;
}

.mode-toggle-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.mode-toggle-label {
    font-size: 0.7rem;
    color: #666;
    text-align: center;
    white-space: nowrap;
    font-weight: bold;
    margin-bottom: 5px;
}

.mode-toggle {
    position: relative;
    width: 60px;
    height: 30px;
    background-color: #f1f1f1;
    border-radius: 30px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.3s;
}

.mode-toggle::after {
    content: '';
    position: absolute;
    width: 26px;
    height: 26px;
    background-color: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

/* Interruptor de modo estudio/examen (izquierda) */
#studyExamToggle.study-mode {
    background-color: #28a745;
}

#studyExamToggle.study-mode::after {
    content: 'üìö';
    transform: translateX(0px);
    background-color: white;
    color: #333;
}

#studyExamToggle.exam-mode {
    background-color: #dc3545;
}

#studyExamToggle.exam-mode::after {
    content: 'üìù';
    transform: translateX(30px);
    background-color: white;
    color: #333;
}

/* Interruptor de modo oscuro (derecha) */
#darkModeToggle.light-mode {
    background-color: #ffd700;
}

#darkModeToggle.light-mode::after {
    content: '‚òÄÔ∏è';
    transform: translateX(0px);
    background-color: white;
    color: #333;
}

#darkModeToggle.dark-mode {
    background-color: #333;
}

#darkModeToggle.dark-mode::after {
    content: 'üåô';
    transform: translateX(30px);
    background-color: #555;
    color: white;
}

/* Estilos para modo oscuro */
body.dark-mode {
    background-color: #121212;
    color: #e0e0e0;
}

body.dark-mode .card {
    background-color: #1e1e1e;
    color: #e0e0e0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

body.dark-mode .question {
    color: #ffffff;
}

body.dark-mode .options label {
    background-color: #2d2d2d;
    border-color: #444;
    color: #e0e0e0;
}

body.dark-mode .options label.selected {
    background-color: #1a3d5c;
    border-color: #007bff;
}

body.dark-mode .options label.option-correct {
    background-color: #1e4620;
    border-color: #28a745;
    color: #ffffff;
}

body.dark-mode .options label.option-wrong {
    background-color: #5a1a1a;
    border-color: #dc3545;
    color: #ffffff;
}

body.dark-mode button {
    background-color: #0056b3;
}

body.dark-mode button.third {
    background-color: #c82333;
}

body.dark-mode button.cuart {
    background-color: #e06c00;
}

body.dark-mode .saved-module.low {
    background-color: #5a1a1a;
    color: #f8d7da;
}

body.dark-mode .saved-module.mid {
    background-color: #5a4a00;
    color: #fff3cd;
}

body.dark-mode .saved-module.high {
    background-color: #1e4620;
    color: #d1e7dd;
}

body.dark-mode .current-mode-indicator {
    background-color: #2d2d2d;
    border-color: #444;
}

body.dark-mode .study-mode-note {
    background-color: #1a3d5c;
    border-left-color: #007bff;
    color: #e0e0e0;
}

body.dark-mode .failed-question {
    border-top-color: #444;
}

body.dark-mode #resumeDialog .card,
body.dark-mode #confirmDialog .card {
    background-color: #2d2d2d;
    color: #e0e0e0;
}

body.dark-mode .mode-toggle-label {
    color: #aaa;
}

body.dark-mode .mode-toggle {
    background-color: #2d2d2d;
}

/* Estilos para los botones externos del M√≥dulo 8 */
.btn-externo {
    display: block;
    width: 100%;
    padding: 14px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    background: #17a2b8;  /* Color turquesa para distinguirlos */
    color: white;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    margin-bottom: 10px;
    transition: background 0.2s;
}

.btn-externo:hover {
    background: #138496;
}

body.dark-mode .btn-externo {
    background: #117a8b;
}

body.dark-mode .btn-externo:hover {
    background: #0e6675;
}

/* Separador para la secci√≥n de M√≥dulo 8 */
.modulo8-section {
    margin-top: 30px;
    border-top: 1px solid #ddd;
    padding-top: 20px;
}

body.dark-mode .modulo8-section {
    border-top-color: #444;
}

/* Responsive para pantallas peque√±as */
@media (max-width: 600px) {
    .mode-toggle-group {
        gap: 120px;
        flex-wrap: wrap;
    }
    
    .mode-toggle {
        width: 55px;
        height: 28px;
    }
    
    .mode-toggle::after {
        width: 24px;
        height: 24px;
    }
    
    #studyExamToggle.exam-mode::after,
    #darkModeToggle.dark-mode::after {
        transform: translateX(27px);
    }
}
</style>
</head>
<body>
<div class="container">

<div id="resumeDialog">
    <div class="card">
        <h2>üíæ Intento guardado üíæ</h2>
        <p>Se detect√≥ un intento previo guardado. ¬øDeseas continuar o empezar de nuevo?</p>
        <button id="continueBtn">Continuar</button>
        <button id="newBtn">Empezar de nuevo</button>
    </div>
</div>

<div id="confirmDialog">
    <div class="card">
        <h2>‚ö†Ô∏è Salir del test ‚ö†Ô∏è</h2>
        <p>¬øEst√°s seguro de que quieres salir? Tu progreso se guardar√° autom√°ticamente y podr√°s continuar m√°s tarde.</p>
        <button id="confirmExitBtn">S√≠, salir</button>
        <button id="cancelExitBtn">Cancelar</button>
    </div>
</div>

<div class="card" id="testSelection">
    <h1>üìö M8 üìö</h1>
    
    <!-- Grupo de interruptores uno al lado del otro -->
    <div class="mode-toggle-group">
        <!-- Interruptor de modo estudio/examen (izquierda) -->
        <div class="mode-toggle-wrapper">
            <div class="mode-toggle-label" id="studyExamLabel">Modo Estudio</div>
            <div class="mode-toggle study-mode" id="studyExamToggle"></div>
        </div>
        
        <!-- Interruptor de modo oscuro (derecha) -->
        <div class="mode-toggle-wrapper">
            <div class="mode-toggle-label" id="darkModeLabel">Modo Claro</div>
            <div class="mode-toggle light-mode" id="darkModeToggle"></div>
        </div>
    </div>
    
    <!-- Indicador del modo actual -->
    <div class="current-mode-indicator study" id="modeIndicator">
        Modo: Estudio - Ver√°s las respuestas inmediatamente
    </div>
    
    <div id="testButtons"></div>

    <!-- ========== NUEVA SECCI√ìN: M√ìDULO 8 - TESTS EXTERNOS ========== -->
    <div class="modulo8-section">
        <h3>DAYPOS</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <a href="https://www.daypo.com/m-viii-policia-proteccion-ciudadana-soc1.html#test" 
               target="_blank" 
               class="btn-externo">
               Socio
            </a>
            <a href="https://www.daypo.com/m-viii-policia-proteccion-ciudadana-psi1.html#test" 
               target="_blank" 
               class="btn-externo">
               Psico
            </a>
            <a href="https://www.daypo.com/m-viii-policia-proteccion-ciudadana-der1.html#test" 
               target="_blank" 
               class="btn-externo">
               Derecho
            </a>
            <a href="https://www.daypo.com/m-viii-policia-proteccion-ciudadana-ttp1.html#test" 
               target="_blank" 
               class="btn-externo">
               TTP 1
            </a>
            <a href="https://www.daypo.com/m-viii-policia-proteccion-ciudadana-ttp2.html#test" 
               target="_blank" 
               class="btn-externo">
               TTP 2
            </a>
        </div>
    </div>
    <!-- ========== FIN NUEVA SECCI√ìN ========== -->

    <button class="third" onclick="goToIndex()">Volver</button>
</div>

<div class="card" id="quizCard">
    <h1 id="themeTitle"></h1>
    <div class="info">
        <div id="progress"></div>
        <div id="timer">‚è± 00:00</div>
    </div>
    <div class="question" id="questionText"></div>
    
    <!-- Contenedor para mostrar nota en modo estudio durante el test -->
    <div id="studyNoteContainer" style="display:none;"></div>
    
    <div class="options" id="options"></div>
    
    <!-- Botones en la misma l√≠nea -->
    <div class="button-row">
        <button id="prevBtn">Anterior</button>
         <button class="third" id="backBtn">Volver</button>
        <button id="nextBtn">Siguiente</button>
       
    </div>
</div>

<div class="card final" id="finalScreen">
    <h1 id="finalTheme"></h1>
    <h2>üìä Resultado final</h2>
    <p id="summary"></p>
    <p id="finalTime"></p>
    <p id="finalNote"></p>
    <div id="failedContainer" style="display:none;"></div>
    <button class="secondary" onclick="restartTest()">Repetir test</button>
    <button class="third" onclick="backToSelection()">Volver</button>
</div>

<div class="card final" id="lastFailsScreen">
    <h1 id="lastFailsTheme"></h1>
    <h2>Preguntas incorrectas o sin responder</h2>
    <div id="lastFailsContainer"></div>
    <button class="third" onclick="backToSelection()">Volver</button>
</div>

</div>

<script>
// === Datos del test ===
const themes = [
    {
  "name": "Examen",
  "questions": [
 {
        'question': 'En relaci√≥n con las consecuencias psicol√≥gicas de las agresiones sexuales, la reacci√≥n a corto plazo, caracterizada por la reevaluaci√≥n cognitiva del hecho, corresponde a:',
        'options': [
            'Fase de shock emocional.',
            'La fase de reordenaci√≥n. ',
            'La fase de adaptaci√≥n.',
            'A cualquier fase en funci√≥n del tipo, intensidad y duraci√≥n del ataque',
        ],
        'answer': 'La fase de reordenaci√≥n. ',
    },
    {
        'question': 'En la atenci√≥n a las v√≠ctimas de agresiones sexuales...',
        'options': [
            'La fase de acogida no es tan importante ya que la agresi√≥n se ha producido y la v√≠ctima se encuentra en estado de shock.',
            'No importa nada el modo de formular las preguntas, lo importante es el acceso a la informaci√≥n.',
            'Se debe vigilar la formulaci√≥n de las preguntas para que la v√≠ctima no se sienta juzgada por la polic√≠a. ',
            'Cualquier lugar es ideal para atender y solicitar informaci√≥n.',
        ],
        'answer': 'Se debe vigilar la formulaci√≥n de las preguntas para que la v√≠ctima no se sienta juzgada por la polic√≠a. ',
    },
    {
        'question': 'La mujer v√≠ctima de violencia en la relaci√≥n de pareja trata de cambiar su estrategia de afrontamiento porque con la anterior no ha obtenido ning√∫n beneficio, sustituy√©ndola por la de asumir que no puede evitar lo que le viene en gana. ¬øQu√© situaci√≥n vive esta mujer?',
        'options': [
            'Aceptaci√≥n condicionada.',
            'Aceptaci√≥n incondicional.',
            'Indefensi√≥n aprendida. ',
            'Desprotecci√≥n estudiada',
        ],
        'answer': 'Indefensi√≥n aprendida. ',
    },
    {
        'question': 'Seg√∫n la teor√≠a de Leonor Walker sobre el ciclo violento, los episodios de maltrato forman parte de un proceso. Indique la opci√≥n correcta:',
        'options': [
            'El proceso consta de tres fases, en este orden: fase de lanzamiento, fase de generaci√≥n de tensi√≥n y fase de calma cari√±osa',
            'El proceso consta de tres fases, en este orden: fase de generaci√≥n/acumulaci√≥n de tensi√≥n, fase de explosi√≥n o descarga de violencia f√≠sica, y fase de arrepentimiento y dulzura. ',
            'El proceso consta de tres fases, en este orden: fase de recuperaci√≥n, fase de arrepentimiento y fase de dulzura.',
            'El proceso consta de cinco fases, en este orden: fase inicial, fase de recuperaci√≥n, fase de explosi√≥n, fase de descarga de violencia f√≠sica, y fase de arrepentimiento y dulzura.',
        ],
        'answer': 'El proceso consta de tres fases, en este orden: fase de generaci√≥n/acumulaci√≥n de tensi√≥n, fase de explosi√≥n o descarga de violencia f√≠sica, y fase de arrepentimiento y dulzura. ',
    },
    {
        'question': 'En cuanto a los indicadores de maltrato y abandono infantil y juvenil...',
        'options': [
            'Los malos tratos y el abandono se producen en un ambiente privado, por lo que es muy probable que sean observados directamente a trav√©s de intervenciones policiales.',
            'La aparici√≥n de un indicador, aunque sea √∫nico y aparezca de forma espor√°dica, es una prueba suficiente para dar cuenta de los malos tratos.',
            'La presencia reiterada de alg√∫n indicador (combinaci√≥n de diferentes indicadores, aparici√≥n de lesiones serias...) debe llamar la atenci√≥n de cualquier persona sobre si estamos ante un caso de maltrato, pero la polic√≠a no puede intervenir (detenciones, notificaciones penales...) hasta que los servicios sociales de atenci√≥n a la infancia y a la adolescencia lo autoricen.',
            'No es tarea imprescindible de los agentes policiales demostrar la existencia de malos tratos y encontrar evidencias. ',
        ],
        'answer': 'No es tarea imprescindible de los agentes policiales demostrar la existencia de malos tratos y encontrar evidencias. ',
    },
    {
        'question': 'Cuando aparecen burlas y cr√≥nicos verbales de este tipo, ¬øqu√© maltrato a los menoresse nos va a presentar?',
        'options': [
            'Abuso sexual.',
            'Abandono emocional.',
            'Abandono f√≠sico.',
            'Maltrato emocional. ',
        ],
        'answer': 'Maltrato emocional. ',
    },
    {
        'question': 'Factores de riesgo asociados a la violencia parental:',
        'options': [
            'Las caracter√≠sticas psicol√≥gicas de los agresores no est√°n relacionadas con la baja tolerancia a la frustraci√≥n, la falta de empat√≠a, la impulsividad y el egocentrismo como factores de crispaci√≥n.',
            'El hecho de que los hijos hayan presenciado episodios violentos dentro de la familia no aumenta en absoluto el riesgo individual de reproducci√≥n de la violencia.',
            'Los cambios en los modelos familiares y laborales son dos de los factores identificados en el contexto social. ',
            'S√≥lo las familias con padres mayores de edad son factores de riesgo familiar.',
        ],
        'answer': 'Los cambios en los modelos familiares y laborales son dos de los factores identificados en el contexto social. ',
    },
    {
        'question': 'Indica cu√°l es la conducta CORRECTA en situaciones de crisis en las que est√°n implicadas personas con delirios o alucinaciones:',
        'options': [
            'Es fundamental mostrar acuerdo con los delirios y alucinaciones para que la persona se sienta protegida y responda a su estado emocional.',
            'Es fundamental intentar su recuperaci√≥n de forma directa y abierta para que tome conciencia del estado mental.',
            'Puede llegar al enfermo para que no se sienta amenazado.',
            'Aceptar sus delirios, como si fueran ciertos para el enfermo, reconociendo los sentimientos que le inspiran. ',
        ],
        'answer': 'Aceptar sus delirios, como si fueran ciertos para el enfermo, reconociendo los sentimientos que le inspiran. ',
    },
    {
        'question': 'Indica la conducta CORRECTA en situaciones de crisis en las que est√°n implicadas personas con trastornos mentales:',
        'options': [
            'Es importante que los dos miembros de la patrulla traten de tranquilizarla: le hablar√°n en voz alta para captar su atenci√≥n y ofrecerle seguridad.',
            'Es conveniente acercarse a √©l con seguridad y firmeza, por lo que le diremos en voz alta y contundente que estamos all√≠ para ayudarle.',
            'Es posible que esa persona escuche voces mientras nos comunicamos con ella, por lo que es conveniente utilizar frases cortas y sencillas. ',
            'Se trata de un problema de salud y no policial, por lo que esperaremos entre los servicios sanitarios y evitaremos actuar con la persona afectada por la crisis.',
        ],
        'answer': 'Es posible que esa persona escuche voces mientras nos comunicamos con ella, por lo que es conveniente utilizar frases cortas y sencillas. ',
    },
    {
        'question': 'Dentro de la fase de intervenci√≥n con una persona que intenta suicidarse de forma leve:',
        'options': [
            'La polic√≠a tratar√° de "ganar tiempo" para preparar a los intervinientes para que tengan tiempo (poner redes, controlar entradas desde otros lugares...). ',
            'Priorizar la llegada de los agentes, lo m√°s r√°pido posible por necesidades, procurando resolver la situaci√≥n lo antes posible.',
            'El agente deber√° dar importancia a lo que indique el suicida y le contar√° ejemplos personales de su vida como forma de prestarle ayuda.',
            'Cuando intervengamos con un suicida, colocaremos varios agentes cerca de √©l, por si todos tuvieran que intervenir en el ataque.',
        ],
        'answer': 'La polic√≠a tratar√° de "ganar tiempo" para preparar a los intervinientes para que tengan tiempo (poner redes, controlar entradas desde otros lugares...). ',
    },
    {
        'question': '¬øPor qu√© hay que considerar m√°s negativa la victimizaci√≥n secundaria que la primaria?',
        'options': [
            'Porque la victimizaci√≥n secundaria responde adecuadamente a las necesidades sociales y emocionales de las v√≠ctimas.',
            'Porque la victimizaci√≥n secundaria es la respuesta a un servicio policial de calidad.',
            'Porque el propio sistema victimiza a la persona que acude al sistema en busca de justicia y protecci√≥n. ',
            'Porque el propio sistema defiende siempre m√°s a los delincuentes que a las v√≠ctimas.',
        ],
        'answer': 'Porque el propio sistema victimiza a la persona que acude al sistema en busca de justicia y protecci√≥n. ',
    },
    {
        'question': 'Se consideran factores de riesgo de acoso escolar:',
        'options': [
            'Estilo educativo y titularidad de gesti√≥n del centro (p√∫blico o privado)',
            'Cualquier valor de austeridad que permita una relaci√≥n democr√°tica entre el alumnado y el profesorado, que fomente la interacci√≥n entre iguales.',
            'La p√©rdida de la capacidad socializadora de la escuela y la influencia de los medios de comunicaci√≥n y las nuevas tecnolog√≠as. ',
            'las dificultades econ√≥micas de las familias para garantizar una educaci√≥n de calidad.',
        ],
        'answer': 'La p√©rdida de la capacidad socializadora de la escuela y la influencia de los medios de comunicaci√≥n y las nuevas tecnolog√≠as. ',
    },
    {
        'question': 'En el √°mbito del acoso escolar y desde el punto de vista de la prevenci√≥n policial, se recogen diferentes actividades. Por ejemplo:',
        'options': [
            'Presencia continuada de polic√≠a no uniformada √∫nicamente en aquellos centros en los que se haya detectado alg√∫n caso de acoso, especialmente contra el profesorado.',
            'Presencia policial reducida s√≥lo en aquellos centros en los que se ha detectado alg√∫n caso de acoso, especialmente contra el profesorado.',
            'Realizaci√≥n de patrullas selectivas y conversaciones peri√≥dicas con los responsables de los centros. ',
            'Colocaci√≥n del veh√≠culo policial en un lugar relativamente oculto, posible caso de inducci√≥n del factor sorpresa e identificaci√≥n m√°s r√°pida a partir de indicadores observados directamente.',
        ],
        'answer': 'Realizaci√≥n de patrullas selectivas y conversaciones peri√≥dicas con los responsables de los centros. ',
    },
    {
        'question': 'En funciones policiales relacionadas con la seguridad de las personas mayores, algunas de ellas ser√°n:',
        'options': [
            'Realizar el trabajo de profesionales sanitarios, psicol√≥gicos, asistentes sociales, etc., en funci√≥n de las necesidades concretas de la persona mayor, siendo la polic√≠a el cuerpo que aparece en primer lugar en la intervenci√≥n en casos de maltrato.',
            'Proteger a este colectivo de determinados delitos contra el patrimonio y los bienes, impidiendo su victimizaci√≥n, facilitando informaci√≥n a √°mbitos como la educaci√≥n vial, el maltrato, etc. ',
            'No implicarse con las necesidades de protecci√≥n de este colectivo, ya que en ning√∫n caso se exigir√° la intervenci√≥n policial como cuesti√≥n exclusiva de los servicios sociales.',
            'Responsabilizarse √∫nicamente de la recepci√≥n de la denuncia en caso de delitos (estafa, maltrato, etc.).',
        ],
        'answer': 'Proteger a este colectivo de determinados delitos contra el patrimonio y los bienes, impidiendo su victimizaci√≥n, facilitando informaci√≥n a √°mbitos como la educaci√≥n vial, el maltrato, etc. ',
    },
    {
        'question': 'Teniendo en cuenta los riesgos de la intervenci√≥n policial en los fen√≥menos de violencia en comportamientos colectivos... ¬øQu√© es el efecto contagio?',
        'options': [
            'Efecto producido por la sola presencia de materiales ofensivos y defensivos con los que se sostiene la ordenaci√≥n.',
            'Es el "efecto de los guantes de boxeo"; es decir, que se producen efectos distintos a los esperados en determinados fen√≥menos sociales.',
            'Que el propio equipo policial adopte alguna caracter√≠stica del grupo a disolver ',
            'No existe tal efecto en la intervenci√≥n policial ante fen√≥menos violentos',
        ],
        'answer': 'Que el propio equipo policial adopte alguna caracter√≠stica del grupo a disolver ',
    },
    {
        'question': '¬øCu√°l de los siguientes factores se considera motivo de NO DENUNCIA de delitos de odio?',
        'options': [
            'Verg√ºenza: algunas v√≠ctimas se sienten avergonzadas o culpables tras haber sido v√≠ctimas de un delito de odio. ',
            'Negarse a solicitar los beneficios de alg√∫n programa de compensaci√≥n a las v√≠ctimas.',
            'Que la v√≠ctima se siente integrada en su comunidad.',
            'Actitud positiva hacia la polic√≠a y el proceso judicial.',
        ],
        'answer': 'Verg√ºenza: algunas v√≠ctimas se sienten avergonzadas o culpables tras haber sido v√≠ctimas de un delito de odio. ',
    },
    {
        'question': 'En el √°mbito de la violencia dom√©stica, las coacciones leves...',
        'options': [
            'Se considerar√°n delitos leves. ',
            'Se consideran conductas at√≠picas.',
            'Deben ser denunciados para ser perseguidos.',
            'Ninguna de las respuestas anteriores es correcta.',
        ],
        'answer': 'Se considerar√°n delitos leves. ',
    },
    {
        'question': 'Se√±ale la respuesta INCORRECTA: La pena del delito de maltrato habitual recogido en el art√≠culo 173.2 del C√≥digo Penal ser√° m√°s severa cuando se trate de uno o varios actos violentos...',
        'options': [
            'Se realicen en sede com√∫n o en el domicilio de la v√≠ctima.',
            'Se realicen con armas.',
            'Cuando se cometan contra una v√≠ctima que conviva con el autor de los hechos y sea especialmente vulnerable. ',
            'Cuando se cometan por infracci√≥n de alguna de las penas previstas en el art√≠culo 48 del C√≥digo Penal.',
        ],
        'answer': 'Cuando se cometan contra una v√≠ctima que conviva con el autor de los hechos y sea especialmente vulnerable. ',
    },
    {
        'question': 'El 23 de febrero, por una supuesta infidelidad, Jon J.K. golpe√≥ a Ander H.L., caus√°ndole un hematoma que no requiri√≥ tratamiento m√©dico. Ambas personas estaban unidas por una relaci√≥n afectiva similar a la conyugal. ¬øQu√© tipo de caso es?',
        'options': [
            'Violencia de g√©nero.',
            'Violencia dom√©stica. ',
            'Violencia de g√©nero cuando la v√≠ctima sea una persona vulnerable.',
            'La vulgaridad.',
        ],
        'answer': 'Violencia dom√©stica. ',
    },
    {
        'question': 'Que cualquier acto de violencia de g√©nero o dom√©stica se haya llevado a cabo con armas...',
        'options': [
            'No siempre supone una agravaci√≥n de la pena. ',
            'Podr√°, en todo caso, agravar la pena.',
            'S√≥lo agravar√° la pena en los casos de violencia de g√©nero.',
            'S√≥lo podr√° agravar la pena en los casos de violencia dom√©stica.',
        ],
        'answer': 'No siempre supone una agravaci√≥n de la pena. ',
    },
    {
        'question': 'Se√±ale la respuesta INCORRECTA:',
        'options': [
            'En los delitos contra la libertad sexual, la intenci√≥n obscena debe deducirse de acuerdo con los medios empleados y los actos cometidos.',
            'En el delito de agresi√≥n sexual, la condici√≥n activa y pasiva puede ser tanto de mujer como de hombre.',
            'En todo caso, se considerar√° abuso sexual no consensuado agravado el que se comete abusando del trastorno mental de una persona. ',
            'Los actos de exhibici√≥n obscena cometidos ante mayores de edad pueden ser constitutivos de infracci√≥n administrativa.',
        ],
        'answer': 'En todo caso, se considerar√° abuso sexual no consensuado agravado el que se comete abusando del trastorno mental de una persona. ',
    },
    {
        'question': 'Actos que atenten contra la libertad e indemnidad sexual de una persona mediante el uso de f√°rmacos para eliminar la violaci√≥n de la v√≠ctima...',
        'options': [
            'Se considerar√°n abusos sexuales',
            'Se considerar√°n agresiones sexuales. ',
            'Se considerar√°n abusos o agresiones sexuales en funci√≥n de la edad de la v√≠ctima.',
            'Como abuso sexual, salvo que el autor sea una persona con una edad similar a la de la v√≠ctima y un grado de desarrollo o madurez.',
        ],
        'answer': 'Se considerar√°n agresiones sexuales. ',
    },
    {
        'question': 'Se√±ale la respuesta CORRECTA: Delito de acoso sexual',
        'options': [
            'Es un delito leve.',
            'S√≥lo es posible a trav√©s de Internet, el tel√©fono o cualquier otra tecnolog√≠a de la informaci√≥n o de los medios de comunicaci√≥n.',
            'Se agravar√° cuando se trate de penetraci√≥n, tanto vaginal, anal como oral.',
            'Ninguna de las respuestas anteriores es correcta.',
        ],
        'answer': 'None',
    },
    {
        'question': 'En el delito de abuso sexual por enga√±o regulado en el art√≠culo 182.2 del C√≥digo Penal.',
        'options': [
            'La v√≠ctima puede ser cualquiera.',
            'Es necesario recurrir a la violencia o a la intimidaci√≥n.',
            'Si la v√≠ctima tiene m√°s de 18 a√±os se agravar√° a√∫n m√°s la pena.',
            'Ninguna de las respuestas anteriores es correcta. ',
        ],
        'answer': 'Ninguna de las respuestas anteriores es correcta. ',
    },
    {
        'question': 'Se√±ale la respuesta CORRECTA',
        'options': [
            'El ejercicio del derecho de reuni√≥n y manifestaci√≥n requiere autorizaci√≥n previa de la autoridad porque puede afectar a los derechos de otras personas.',
            'S√≥lo ser√° necesaria la autorizaci√≥n previa de la autoridad cuando afecte a derechos de otras personas.',
            'El derecho de reuni√≥n y manifestaci√≥n es un derecho absoluto y sin l√≠mites.',
            'El derecho de reuni√≥n y manifestaci√≥n no es absoluto, es decir, tiene ciertos l√≠mites. ',
        ],
        'answer': 'El derecho de reuni√≥n y manifestaci√≥n no es absoluto, es decir, tiene ciertos l√≠mites. ',
    },
    {
        'question': 'Seg√∫n el art√≠culo 20 de la Ley Org√°nica de Seguridad Ciudadana se permite la exploraci√≥n externa y superficial del cuerpo de la persona.',
        'options': [
            'S√≥lo si existe una situaci√≥n de urgencia por grave riesgo inminente para los agentes.',
            'Cuando existan indicios racionales de que se pueden encontrar instrumentos, efectos u otros objetos relevantes para realizar funciones de investigaci√≥n y prevenci√≥n. ',
            'No sea contrario a la voluntad del afectado.',
            'Funciones de investigaci√≥n, pero no de prevenci√≥n.',
        ],
        'answer': 'Cuando existan indicios racionales de que se pueden encontrar instrumentos, efectos u otros objetos relevantes para realizar funciones de investigaci√≥n y prevenci√≥n. ',
    },
    {
        'question': 'En el procedimiento administrativo sancionador:',
        'options': [
            'Rige el principio de irretroactividad de la norma sancionadora siempre y en todo caso.',
            'La fase de instrucci√≥n y la sancionadora corresponden al mismo √≥rgano.',
            'Cualquier persona tiene derecho a conocer, en cualquier momento, el estado de la tramitaci√≥n del procedimiento.',
            'La Ley se√±ala un plazo fuera del cual ya no podr√°n ser sancionados los hechos constitutivos de una presunta infracci√≥n administrativa. ',
        ],
        'answer': 'La Ley se√±ala un plazo fuera del cual ya no podr√°n ser sancionados los hechos constitutivos de una presunta infracci√≥n administrativa. ',
    },
    {
        'question': 'En caso de conflicto entre el vendedor y un cliente en el supermercado "Sustrai", los agentes actuantes actuar√°n, con car√°cter general, de la siguiente manera:',
        'options': [
            'Separar - relajar la situaci√≥n - identificar - dar soluciones - actuar conforme a derecho.',
            'Separar - identificar - relajar la situaci√≥n - actuar conforme a derecho - dar soluciones.',
            'Separar -relajar la situaci√≥n - identificar - actuar seg√∫n derecho - dar soluciones. ',
            'Relajar la situaci√≥n - separar - identificar - actuar conforme a derecho - dar soluciones.',
        ],
        'answer': 'Separar -relajar la situaci√≥n - identificar - actuar seg√∫n derecho - dar soluciones. ',
    },
    {
        'question': 'Se√±ale qu√© documentaci√≥n tendr√°n que cumplimentar los agentes de la Ertzaintza en el siguiente caso: A las 01:15 horas del d√≠a de hoy, agentes de la Ertzaintza realizando inspecci√≥n de locales de juego observan en un bingo a dos j√≥venes. Los agentes verifican sus identidades y comprueban que ambos tienen 16 a√±os, raz√≥n por la cual los agentes proceden a denunciar la situaci√≥n detectada, para ello:',
        'options': [
            'Cumplimentar√°n un acta de menores en la que figurar√°n como denunciados los padres o tutores de los menores y dos diligencias de identificaci√≥n de la persona menor de edad.',
            'Cumplimentar√°n un acta de menores en la que figurar√°n como denunciados los dos menores.',
            'Cumplimentar√°n un informe que se remitir√° a los servicios sociales competentes.',
            'Cumplimentar√°n un acta de menores en la que figurar√° como denunciado el titular del establecimiento y dos diligencias de identificaci√≥n de las personas menores de edad. ',
        ],
        'answer': 'Cumplimentar√°n un acta de menores en la que figurar√° como denunciado el titular del establecimiento y dos diligencias de identificaci√≥n de las personas menores de edad. ',
    },
    {
        'question': 'Cuando se dice que la Polic√≠a tiene funciones de mediaci√≥n en el √°mbito de la inmigraci√≥n nos referimos a:',
        'options': [
            'Las funciones relacionadas con la aplicaci√≥n de la ley - C√≥digo Penal y legislaci√≥n extranjera -.',
            'Funciones orientadas a ofrecer informaci√≥n que corrobore los estereotipos sociales y culturales y su vigencia. ',
            'La intervenci√≥n polic√≠a en conflictos de connotaci√≥n racista, facilitando el acercamiento entre los grupos implicados y contribuyendo as√≠ a una soluci√≥n.',
            'Las funciones encaminadas a la condonaci√≥n de los delitos que contengan alg√∫n elemento relacionado con la diversidad cultural.',
        ],
        'answer': 'Funciones orientadas a ofrecer informaci√≥n que corrobore los estereotipos sociales y culturales y su vigencia. ',
    },
    {
        'question': 'El agente policial, al intervenir con alguien que amenace con suicidarse, se preguntar√° por el motivo que le ha llevado a esta situaci√≥n:',
        'options': [
            'Es un tema tab√∫ y, por tanto, que hay que evitar siempre, porque provoca el suicidio.',
            'No provoca el suicidio, sino que ayuda a la persona a exteriorizar sus sentimientos. ',
            'S√≥lo los familiares m√°s cercanos pueden pregunt√°rselo.',
            'Todas las respuestas anteriores son err√≥neas.',
        ],
        'answer': 'No provoca el suicidio, sino que ayuda a la persona a exteriorizar sus sentimientos. ',
    },
    {
        'question': 'Se√±ale la respuesta CORRECTA:',
        'options': [
            'Se proh√≠be la entrada y permanencia de menores de 18 a√±os en establecimientos p√∫blicos cerrados que sirven bebidas alcoh√≥licas.',
            'Se proh√≠be la venta de alcohol a personas de hasta 16 uretras.',
            'Se proh√≠be suministrar alcohol a los alumnos de hasta 16 a√±os en los centros educativos.',
            'Se proh√≠be la entrada y permanencia de menores de 16 a√±os en establecimientos p√∫blicos cerrados que sirven bebidas alcoh√≥licas, salvo que est√©n acompa√±ados por sus responsables. ',
        ],
        'answer': 'Se proh√≠be la entrada y permanencia de menores de 16 a√±os en establecimientos p√∫blicos cerrados que sirven bebidas alcoh√≥licas, salvo que est√©n acompa√±ados por sus responsables. ',
    },
    {
        'question': '¬øQu√© son las "tintas iridiscentes"?',
        'options': [
            'Son tintas en las que se produce el efecto relieve debido al sistema de estampaci√≥n a altas presiones y temperaturas',
            'Necesitan la acci√≥n de una l√°mpara de ultravioleta para ser visibles',
            'Con luz viva y cambiando de posici√≥n, cambian de brillo ',
            'Son tintas de impresi√≥n con pigmentos √≥pticamente vol√°tiles que presentan grandes cambios de color en funci√≥n del √°ngulo de observaci√≥n - O iluminaci√≥n',
        ],
        'answer': 'Con luz viva y cambiando de posici√≥n, cambian de brillo ',
    },
    {
        'question': 'Estas son tres de las medidas de seguridad fundamentales que se pueden ver en los billetes de euro de la serie Europa:',
        'options': [
            'Marca de agua con la imagen de la diosa Europa, holograma con la imagen de la diosa Europa y la palabra Euro impresa por tipograf√≠a',
            'Holograma con la imagen de la diosa Europa, n√∫mero verde esmeralda y t√©rmino Euro impreso con tinta OVI (imagen √≥pticamente variable)',
            'Marca de agua con la imagen de la diosa Europa, n√∫mero verde esmeralda y fibrillas (que reaccionan con luz ultravioleta. ',
            'Marca de agua con la imagen de la diosa Europa, n√∫mero verde esmeralda y planchetes (que reaccionan con luz ultravioleta.',
        ],
        'answer': 'Marca de agua con la imagen de la diosa Europa, n√∫mero verde esmeralda y fibrillas (que reaccionan con luz ultravioleta. ',
    },
    {
        'question': '¬øCu√°les de las siguientes medidas se pueden adoptar para evitar la victimizaci√≥n secundaria en la solicitud policial?',
        'options': [
            '"La primera barrera, que debe ser r√°pida en el tiempo para priorizar la detenci√≥n del delincuente sobre cualquier otra atenci√≥n a la v√≠ctima.',
            'Formular preguntas sin valorar necesariamente el estado emocional de la v√≠ctima, priorizando la detenci√≥n del delincuente y garantizando el cumplimiento de las funciones represivas.',
            'Escuchar a la v√≠ctima transmitiendo empat√≠a y apoyo, evitando comportamientos verbales o no verbales inadecuados. ',
            'La pr√°ctica de diligencias administrativas, ya que el agente policial no puede realizar las tareas de atenci√≥n y escucha que corresponden a otros profesionales.',
        ],
        'answer': 'Escuchar a la v√≠ctima transmitiendo empat√≠a y apoyo, evitando comportamientos verbales o no verbales inadecuados. ',
    },
    {
        'question': '¬øQu√© son los micromachismos, seg√∫n la definici√≥n de Luis Bonino?',
        'options': [
            'Manifestaciones que favorecen la simetr√≠a de las relaciones y la autonom√≠a femenina.',
            'Maniobras ejercidas por el hombre: avalan el aumento del poder personal o interpersonal de la mujer afectivamente vinculada',
            'Los comportamientos de control y dominaci√≥n de los hombres, que obstaculizan y dificultan la paridad entre mujeres y hombres en la vida cotidiana. ',
            'Un conjunto de maniobras en las que el hombre hace uso de la fuerza moral, ps√≠quica, econ√≥mica y de personalidad para dominar a la mujer tanto en el √°mbito p√∫blico como en el privado.',
        ],
        'answer': 'Los comportamientos de control y dominaci√≥n de los hombres, que obstaculizan y dificultan la paridad entre mujeres y hombres en la vida cotidiana. ',
    },
    {
        'question': 'Entre las intervenciones que se est√°n llevando a cabo para reducir la violencia contra las mujeres en las relaciones de pareja, se encuentran las incluidas dentro del t√©rmino PREVENCI√ìN. ¬øA qu√© se refiere exactamente este t√©rmino?',
        'options': [
            'A la primera intervenci√≥n ante el problema: protecci√≥n legal y social.',
            'Desarrollar los medios materiales y las herramientas de intervenci√≥n de todos los grupos de profesionales que trabajan directamente con la v√≠ctima en las actuaciones de las Administraciones P√∫blicas.',
            'La educaci√≥n en los principios de igualdad entre mujeres y hombres, con especial implicaci√≥n de la familia, la escuela y los medios de comunicaci√≥n. ',
            'Recabar informaci√≥n sobre los denunciantes.',
        ],
        'answer': 'La educaci√≥n en los principios de igualdad entre mujeres y hombres, con especial implicaci√≥n de la familia, la escuela y los medios de comunicaci√≥n. ',
    },
    {
        'question': '¬øCu√°l es el objetivo de la prevenci√≥n social en el marco de las actuaciones policiales con menores?',
        'options': [
            'Impedir o cortar las carreras criminales. ',
            'Desarrollar un enfoque estrictamente legal en las intervenciones policiales.',
            'Controlar la negligencia de las familias desestructuradas en situaci√≥n de exclusi√≥n.',
            'Promover la lucha jur√≠dico-penal y policial contra la reincidencia de menores.',
        ],
        'answer': 'Impedir o cortar las carreras criminales. ',
    },
    {
        'question': 'Entre las funciones de prevenci√≥n policial a desarrollar con los menores se encuentran:',
        'options': [
            '√önicamente el control del consumo de bebidas alcoh√≥licas y otras drogas.',
            'Controlar la evoluci√≥n del fracaso escolar y de la indisciplina de los centros educativos en familias en riesgo de exclusi√≥n social.',
            'La escolarizaci√≥n y el control del consumo de bebidas alcoh√≥licas. ',
            'El control exclusivo de las familias en situaci√≥n de riesgo de exclusi√≥n social.',
        ],
        'answer': 'La escolarizaci√≥n y el control del consumo de bebidas alcoh√≥licas. ',
    },
    {
        'question': 'Para ver el interior de un edificio que ha sonado una alarma, el encargado nos deja entrar. ¬øQu√© acceso vamos a seguir?',
        'options': [
            'La inspecci√≥n se realizar√° de forma coordinada entre ambos agentes de la patrulla, pudiendo perderse el contacto visual entre ambos para agilizar el trabajo.',
            'Se comprobar√° si los objetos contienen se√±ales de violencia. Para ello se inspeccionar√°n las puertas, ventanas, cristales y todas las dependencias del local. Sin olvidar el techo o el tejado. ',
            'los agentes del recurso de apoyo nunca podr√°n inspeccionar el local, ya que deben controlar el exterior.',
            'Si el responsable del local est√° presente, se le permitir√° el acceso. As√≠, proporcionar√° informaci√≥n sobre las caracter√≠sticas del local.',
        ],
        'answer': 'Se comprobar√° si los objetos contienen se√±ales de violencia. Para ello se inspeccionar√°n las puertas, ventanas, cristales y todas las dependencias del local. Sin olvidar el techo o el tejado. ',
    },
    {
        'question': 'Si en una pelea en el interior de una vivienda existe un riesgo inminente para la integridad f√≠sica o la vida de las personas, los agentes actuar√°n de la siguiente manera:',
        'options': [
            'La apertura de la puerta ser√° forzada con los medios que se consideren oportunos o que est√©n a nuestro alcance. ',
            'Estar√°n pendientes del orden del Agente Primero o Jefe de Patrulla, aunque √©stos no est√©n en el lugar.',
            'Se comunicar√° a Ardatz y esperaremos las instrucciones.',
            'Se comunicar√° a Ardatz y esperaremos al recurso de los bomberos que ponga en marcha.',
        ],
        'answer': 'La apertura de la puerta ser√° forzada con los medios que se consideren oportunos o que est√©n a nuestro alcance. ',
    },
        ]
    },
    ]

// Variables
let theme=null,index=0,correct=0,incorrect=0,startTime=Date.now(),answers=[],timerInterval;
let mode = "study"; // Valor por defecto

// DOM
const themeTitle=document.getElementById("themeTitle");
const questionText=document.getElementById("questionText");
const optionsDiv=document.getElementById("options");
const nextBtn=document.getElementById("nextBtn");
const prevBtn=document.getElementById("prevBtn");
const backBtn=document.getElementById("backBtn");
const progress=document.getElementById("progress");
const timer=document.getElementById("timer");
const quizCard=document.getElementById("quizCard");
const finalScreen=document.getElementById("finalScreen");
const lastFailsScreen=document.getElementById("lastFailsScreen");
const summary=document.getElementById("summary");
const finalTime=document.getElementById("finalTime");
const finalNote=document.getElementById("finalNote");
const finalTheme=document.getElementById("finalTheme");
const lastFailsTheme=document.getElementById("lastFailsTheme");
const failedContainer=document.getElementById("failedContainer");
const lastFailsContainer=document.getElementById("lastFailsContainer");
const resumeDialog=document.getElementById("resumeDialog");
const continueBtn=document.getElementById("continueBtn");
const newBtn=document.getElementById("newBtn");
const testSelection=document.getElementById("testSelection");
const testButtonsDiv=document.getElementById("testButtons");
const modeIndicator=document.getElementById("modeIndicator");
const studyNoteContainer=document.getElementById("studyNoteContainer");
const confirmDialog=document.getElementById("confirmDialog");
const confirmExitBtn=document.getElementById("confirmExitBtn");
const cancelExitBtn=document.getElementById("cancelExitBtn");

// Nuevos elementos para los interruptores
const studyExamToggle = document.getElementById("studyExamToggle");
const studyExamLabel = document.getElementById("studyExamLabel");
const darkModeToggle = document.getElementById("darkModeToggle");
const darkModeLabel = document.getElementById("darkModeLabel");

// Funciones para el toggle de modo estudio/examen
function toggleStudyExamMode() {
    if (mode === "study") {
        setMode("exam");
    } else {
        setMode("study");
    }
}

function setMode(newMode) {
    mode = newMode;
    
    // Guardar el modo seleccionado en localStorage
    localStorage.setItem("testMode", mode);
    
    // Actualizar interruptor estudio/examen visualmente
    if (mode === "exam") {
        studyExamToggle.className = "mode-toggle exam-mode";
        studyExamLabel.textContent = "Modo Examen";
        modeIndicator.textContent = "Modo: Examen - Solo ver√°s las respuestas al final";
        modeIndicator.className = "current-mode-indicator exam";
    } else {
        studyExamToggle.className = "mode-toggle study-mode";
        studyExamLabel.textContent = "Modo Estudio";
        modeIndicator.textContent = "Modo: Estudio - Ver√°s las respuestas inmediatamente";
        modeIndicator.className = "current-mode-indicator study";
    }
    
    // Reconstruir los botones de test
    buildTestButtons();
}

// Cargar el modo guardado del localStorage al iniciar
function loadSavedMode() {
    const savedMode = localStorage.getItem("testMode");
    if (savedMode === "study" || savedMode === "exam") {
        setMode(savedMode);
    } else {
        setMode("study"); // Valor por defecto si no hay nada guardado
    }
}

// Funciones para el modo oscuro
function initDarkMode() {
    // Cargar preferencia de modo oscuro
    const darkMode = localStorage.getItem("darkMode") === "true";
    
    if (darkMode) {
        enableDarkMode();
    } else {
        disableDarkMode();
    }
    
    // Configurar eventos para los interruptores
    studyExamToggle.addEventListener("click", toggleStudyExamMode);
    darkModeToggle.addEventListener("click", toggleDarkMode);
    
    // Tambi√©n permitir arrastre como el otro toggle
    setupToggleDrag(studyExamToggle, toggleStudyExamMode);
    setupToggleDrag(darkModeToggle, toggleDarkMode);
}

function toggleDarkMode() {
    if (document.body.classList.contains("dark-mode")) {
        disableDarkMode();
    } else {
        enableDarkMode();
    }
}

function enableDarkMode() {
    document.body.classList.add("dark-mode");
    darkModeToggle.className = "mode-toggle dark-mode";
    darkModeLabel.textContent = "Modo Oscuro";
    localStorage.setItem("darkMode", "true");
}

function disableDarkMode() {
    document.body.classList.remove("dark-mode");
    darkModeToggle.className = "mode-toggle light-mode";
    darkModeLabel.textContent = "Modo Claro";
    localStorage.setItem("darkMode", "false");
}

// Funci√≥n gen√©rica para arrastre en toggles
function setupToggleDrag(toggleElement, toggleFunction) {
    let dragStart = 0;
    let isDragging = false;
    
    toggleElement.addEventListener('touchstart', (e) => {
        dragStart = e.touches[0].clientX;
        isDragging = true;
        e.preventDefault();
    }, {passive: false});
    
    toggleElement.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
    }, {passive: false});
    
    toggleElement.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        
        const dragEnd = e.changedTouches[0].clientX;
        const deltaX = dragEnd - dragStart;
        
        // Si se arrastra horizontalmente m√°s de 20px, cambiar modo
        if (Math.abs(deltaX) > 20) {
            toggleFunction();
        }
        
        isDragging = false;
        e.preventDefault();
    }, {passive: false});
    
    // Para mouse
    toggleElement.addEventListener('mousedown', (e) => {
        dragStart = e.clientX;
        isDragging = true;
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
    });
    
    document.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        
        const dragEnd = e.clientX;
        const deltaX = dragEnd - dragStart;
        
        // Si se arrastra horizontalmente m√°s de 20px, cambiar modo
        if (Math.abs(deltaX) > 20) {
            toggleFunction();
        }
        
        isDragging = false;
        e.preventDefault();
    });
}

// Funciones
function getTestStateKey(){ return "testState_" + theme.name + "_" + mode; }

function buildTestButtons(){
    testButtonsDiv.innerHTML="";
    const scores=JSON.parse(localStorage.getItem("moduleScores"))||{};
    themes.forEach((t,i)=>{
        const btn=document.createElement("button"); 
        btn.textContent=t.name;

        const saved = localStorage.getItem("testState_" + t.name + "_" + mode);
        if(saved){ btn.textContent += " üíæ"; }

        btn.onclick=()=>startSelectedTest(i); 
        testButtonsDiv.appendChild(btn);

        const s=scores[t.name]?.[mode];
        if(s?.ultimaNota!==undefined && s?.mejorNota!==undefined){
            const scoreDiv=document.createElement("div");
            const clase=s.ultimaNota<5?"low":s.ultimaNota<8?"mid":"high";
            scoreDiv.className=`saved-module ${clase}`; 
            scoreDiv.id=`score-${i}`;
            scoreDiv.innerHTML=`<p>√öltima nota: ${s.ultimaNota}/10</p>
                                  <p>Mejor nota: ${s.mejorNota}/10</p>`;
            const answersList=s.answers||[];
            const failed=answersList.filter(a=>!a.selected || a.selected!==a.correct);
            if(failed.length>0){
                const failBtn=document.createElement("button"); 
                failBtn.textContent="√öltimos fallos";
                failBtn.style.marginTop="6px"; 
                failBtn.className = "cuart";
                failBtn.onclick=()=>showLastFails(t.name);
                scoreDiv.appendChild(failBtn);
            }
            testButtonsDiv.appendChild(scoreDiv);
        }
    });
}

function startSelectedTest(i){ 
    theme=themes[i]; 
    testSelection.style.display="none"; 
    initTest(false);
}

function goToIndex(){ 
    window.location.href="../index.html";
}

function backToSelection(){ 
    clearInterval(timerInterval); 
    quizCard.style.display="none"; 
    finalScreen.style.display="none"; 
    lastFailsScreen.style.display="none"; 
    buildTestButtons(); 
    testSelection.style.display="block";
}

function showExitConfirmation() {
    confirmDialog.style.display = "flex";
}

function initTest(loadSaved=false){
    if(!theme){ 
        buildTestButtons(); 
        testSelection.style.display="block"; 
        quizCard.style.display="none"; 
        finalScreen.style.display="none"; 
        return;
    }
    
    const saved = localStorage.getItem(getTestStateKey());
    if(!loadSaved && saved){ 
        resumeDialog.style.display="flex"; 
        quizCard.style.display="none"; 
        finalScreen.style.display="none"; 
        return;
    }
    
    resumeDialog.style.display="none"; 
    quizCard.style.display="block"; 
    finalScreen.style.display="none"; 
    lastFailsScreen.style.display="none";
    
    if(loadSaved && saved){ 
        const state=JSON.parse(saved); 
        index=state.index; 
        correct=state.correct; 
        incorrect=state.incorrect; 
        startTime=state.startTime; 
        answers=state.answers; 
        // Recalcular correct e incorrect basado en las respuestas guardadas
        recalculateCounts();
    } else{ 
        index=0; 
        correct=0; 
        incorrect=0; 
        startTime=Date.now(); 
        answers=[]; 
        localStorage.removeItem(getTestStateKey()); 
    }
    
    themeTitle.textContent=theme.name; 
    clearInterval(timerInterval); 
    timerInterval=setInterval(updateTimer,1000); 
    loadQuestion();
}

function recalculateCounts() {
    correct = 0;
    incorrect = 0;
    answers.forEach((answer, idx) => {
        if (answer && answer.selected) {
            if (answer.selected === answer.correct) {
                correct++;
            } else {
                incorrect++;
            }
        }
    });
}

function loadQuestion() {
    const q = theme.questions[index];
    questionText.textContent = q.question;
    optionsDiv.innerHTML = "";
    progress.textContent = `Pregunta ${index+1}/${theme.questions.length}`;

    q.options.forEach(opt => {
        const label = document.createElement("label");
        label.textContent = opt;

        // Si ya hab√≠as respondido
        if (answers[index] && answers[index].selected === opt) {
            label.classList.add("selected");
            
            // En modo estudio, mostrar si la respuesta seleccionada es correcta o incorrecta
            if (mode === "study") {
                if (opt === q.answer) {
                    label.classList.add("option-correct");
                } else {
                    label.classList.add("option-wrong");
                    // Mostrar tambi√©n la respuesta correcta
                    document.querySelectorAll(".options label").forEach(l => {
                        if (l.textContent === q.answer) l.classList.add("option-correct");
                    });
                }
            }
        }

        label.addEventListener("click", () => {
            // Quitar seleccionadas
            document.querySelectorAll(".options label").forEach(l => {
                l.classList.remove("selected", "option-correct", "option-wrong");
            });
            label.classList.add("selected");

            // Guardar respuesta
            const previousAnswer = answers[index];
            const wasCorrect = previousAnswer && previousAnswer.selected === previousAnswer?.correct;
            
            // Si ya hab√≠a una respuesta anterior, quitar su conteo
            if (previousAnswer && previousAnswer.selected) {
                if (wasCorrect) {
                    correct--;
                } else if (previousAnswer.selected) {
                    incorrect--;
                }
            }

            answers[index] = {
                question: q.question,
                options: q.options,
                correct: q.answer,
                selected: opt,
                number: index + 1
            };

            // Contar correctas/incorrectas
            if (opt === q.answer) {
                correct++;
            } else {
                incorrect++;
            }

            // En modo estudio, mostrar inmediatamente si es correcta o incorrecta
            if (mode === "study") {
                document.querySelectorAll(".options label").forEach(l => {
                    if (l.textContent === q.answer) l.classList.add("option-correct");
                    if (l.textContent === opt && opt !== q.answer) l.classList.add("option-wrong");
                });
                
                // Actualizar nota en tiempo real con penalizaci√≥n
                const correctCount = answers.filter(a => a && a.selected === a.correct).length;
                const incorrectCount = answers.filter(a => a && a.selected && a.selected !== a.correct).length;
                const rawScore = correctCount - (incorrectCount/3);
                const notaActual = Math.max(0, (rawScore / theme.questions.length) * 10).toFixed(1);
            }

            saveProgress();
        });

        optionsDiv.appendChild(label);
    });

    prevBtn.style.display = index === 0 ? "none" : "inline-block";
    nextBtn.textContent = index === theme.questions.length - 1 ? "Finalizar" : "Siguiente";
}

function saveProgress(){ 
    localStorage.setItem(getTestStateKey(), JSON.stringify({ 
        index, 
        correct, 
        incorrect, 
        startTime, 
        answers 
    })); 
}

nextBtn.addEventListener("click",()=>{
    const selectedAnswer = answers[index]?.selected || null;
    const q = theme.questions[index];
    
    // Si no hay respuesta guardada, guardar una vac√≠a
    if (!answers[index]) {
        answers[index] = { 
            question: q.question, 
            options: q.options, 
            correct: q.answer, 
            selected: selectedAnswer, 
            number: index+1 
        };
    }
    
    saveProgress();
    
    if(index < theme.questions.length-1){ 
        index++; 
        loadQuestion(); 
    } else { 
        finishTest(); 
    }
});

prevBtn.addEventListener("click",()=>{ 
    if(index>0) {
        index--; 
        loadQuestion(); 
    }
});

backBtn.addEventListener("click", showExitConfirmation);

confirmExitBtn.addEventListener("click", () => {
    confirmDialog.style.display = "none";
    // Guardar el progreso antes de salir
    saveProgress();
    backToSelection();
});

cancelExitBtn.addEventListener("click", () => {
    confirmDialog.style.display = "none";
});

function finishTest(){
    clearInterval(timerInterval); 
    localStorage.removeItem(getTestStateKey()); 
    quizCard.style.display="none"; 
    finalScreen.style.display="block";
    
    // Mostrar el nombre del tema en los resultados
    finalTheme.textContent = `${theme.name}`;
    
    const totalSeconds=Math.floor((Date.now()-startTime)/1000); 
    const min=String(Math.floor(totalSeconds/60)).padStart(2,"0"); 
    const sec=String(totalSeconds%60).padStart(2,"0");
    
    // AMBOS MODOS USAN PENALIZACI√ìN (1/3 por incorrecta)
    const rawScore = correct - (incorrect/3);
    const note = Math.max(0,(rawScore/theme.questions.length)*10).toFixed(2);
    
    summary.innerHTML=`‚úîÔ∏è Correctas: ${correct}<br>‚ùå Incorrectas: ${incorrect}<br>üìù Total preguntas: ${theme.questions.length}`;
    finalTime.textContent=`‚è± Tiempo: ${min}:${sec}`;
    finalNote.innerHTML=`üéØ Nota final: <strong>${note}/10</strong>`;
    
    saveModuleScore(theme.name,note);

    failedContainer.style.display="block"; 
    failedContainer.innerHTML="";
    const failed=answers.filter(a=> !a.selected || (a.selected !== a.correct));
    if(failed.length){
        const failedDiv=document.createElement("div"); 
        failedDiv.innerHTML=`<h3>Preguntas incorrectas o sin responder.</h3>`;
        failed.forEach(a=>{
            const div=document.createElement("div"); 
            div.className="failed-question";
            div.innerHTML=`<div class="question-text">Pregunta ${a.number}: ${a.question}</div>`;
            const opts=document.createElement("div"); 
            opts.className="options";
            a.options.forEach(opt=>{
                const label=document.createElement("label"); 
                label.textContent=opt;
                if(opt===a.correct) label.classList.add("option-correct");
                if(opt===a.selected && opt !== a.correct) label.classList.add("option-wrong");
                opts.appendChild(label);
            });
            div.appendChild(opts); 
            failedDiv.appendChild(div);
        });
        failedContainer.appendChild(failedDiv);
    }
}

function saveModuleScore(moduleName,nota){
    const numericNote=parseFloat(nota);
    const scores=JSON.parse(localStorage.getItem("moduleScores"))||{};
    if(!scores[moduleName]) scores[moduleName]={};
    if(!scores[moduleName][mode]) scores[moduleName][mode]={};
    scores[moduleName][mode].ultimaNota=numericNote;
    scores[moduleName][mode].answers=answers;
    if(!scores[moduleName][mode].mejorNota || numericNote>scores[moduleName][mode].mejorNota) scores[moduleName][mode].mejorNota=numericNote;
    localStorage.setItem("moduleScores",JSON.stringify(scores));
    buildTestButtons();
}

function updateTimer(){ 
    const elapsed=Math.floor((Date.now()-startTime)/1000); 
    const m=String(Math.floor(elapsed/60)).padStart(2,"0"); 
    const s=String(elapsed%60).padStart(2,"0"); 
    timer.textContent=`‚è± ${m}:${s}`; 
}

function restartTest(){ 
    correct=0; 
    incorrect=0; 
    index=0; 
    answers=[]; 
    startTime=Date.now(); 
    localStorage.removeItem(getTestStateKey()); 
    initTest(false); 
}

continueBtn.addEventListener("click",()=>initTest(true));
newBtn.addEventListener("click",()=>restartTest());

function showLastFails(moduleName){
    const scores=JSON.parse(localStorage.getItem("moduleScores"))||{};
    const s = scores[moduleName]?.[mode];
    if(!s?.answers){ alert("No hay respuestas guardadas"); return;}
    const failed=s.answers.filter(a=>!a.selected || a.selected!==a.correct);
    if(failed.length===0){ alert("No hay fallos o sin responder"); return;}
    
    // Mostrar el nombre del tema
    lastFailsTheme.textContent = `${moduleName}`;
    
    lastFailsContainer.innerHTML="";
    failed.forEach(a=>{
        const div=document.createElement("div"); div.className="failed-question";
        div.innerHTML=`<div class="question-text">Pregunta ${a.number}: ${a.question}</div>`;
        const opts=document.createElement("div"); opts.className="options";
        a.options.forEach(opt=>{
            const label=document.createElement("label"); label.textContent=opt;
            if(opt===a.correct) label.classList.add("option-correct");
            if(opt===a.selected) label.classList.add("option-wrong");
            opts.appendChild(label);
        });
        div.appendChild(opts); lastFailsContainer.appendChild(div);
    });
    testSelection.style.display="none"; finalScreen.style.display="none"; quizCard.style.display="none"; lastFailsScreen.style.display="block";
}

// Inicializar
loadSavedMode(); // Cargar el modo guardado en localStorage
initDarkMode(); // Inicializar modo oscuro
initTest();
</script>
</body>
</html>
