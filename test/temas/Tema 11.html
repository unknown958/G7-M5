<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Test M√≥dulo 5</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { 
    box-sizing: border-box; 
    margin: 0;
    padding: 0;
}

body { 
    font-family: 'Arial', sans-serif; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.container { 
    max-width: 900px; 
    width: 100%;
    margin: auto; 
}

/* Tarjeta principal */
.card { 
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    position: relative;
    overflow: hidden;
}

/* Decoraci√≥n de la tarjeta */
.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
}

/* T√≠tulos */
h1, h2, h3 {
    text-align: center;
    margin-bottom: 25px;
}

h1 {
    color: #2d3436;
    font-size: 2.5rem;
    background: linear-gradient(90deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: bold;
    margin-bottom: 20px;
}

h2 {
    color: #2d3436;
    font-size: 2rem;
    margin-bottom: 30px;
}

/* Informaci√≥n de progreso */
.info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
    font-weight: bold;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 12px;
    border: 2px solid #e9ecef;
}

#progress {
    color: #495057;
    font-size: 1.1rem;
}

#timer {
    color: #667eea;
    font-size: 1.1rem;
    font-weight: bold;
}

/* Pregunta */
.question {
    font-size: 1.3rem;
    margin-bottom: 30px;
    font-weight: bold;
    color: #2d3436;
    line-height: 1.5;
    padding: 0 10px;
}

/* Opciones */
.options {
    margin-bottom: 30px;
}

.options label {
    display: block;
    padding: 20px 25px;
    margin-bottom: 15px;
    border-radius: 15px;
    border: 3px solid #e9ecef;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
    color: #495057;
    font-size: 1.1rem;
    line-height: 1.4;
    position: relative;
}

.options label:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.1);
    border-color: #667eea;
    background: white;
}

.options label.selected {
    background: #e8f4ff;
    border-color: #667eea;
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
}

.options label.option-wrong {
    border-color: #ff6b6b;
    background: #fff5f5;
}

.options label.option-correct {
    border-color: #4ecdc4;
    background: #f0fffd;
}

/* Botones */
button {
    padding: 18px 30px;
    font-size: 1.1rem;
    border-radius: 12px;
    border: none;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: bold;
    width: 100%;
    margin-top: 10px;
}

button:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
}

button.secondary {
    background: linear-gradient(135deg, #4ecdc4, #45b7d1);
}

#prevBtn, #nextBtn {
    width: 48%;
    padding: 18px;
}

.button-container {
    display: flex;
    gap: 4%;
    margin-top: 20px;
    justify-content: flex-end;
}

/* Pantalla final */
.final { 
    display: none; 
    text-align: center;
}

.final h2 {
    font-size: 2.5rem;
    margin-bottom: 30px;
}

#summary, #finalTime, #finalNote {
    font-size: 1.2rem;
    margin-bottom: 20px;
    color: #495057;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 12px;
}

#finalNote {
    font-size: 1.5rem;
    font-weight: bold;
    color: #667eea;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 20px;
    border-left: 5px solid #667eea;
}

/* Preguntas incorrectas */
.failed-question {
    margin-top: 30px;
    padding-top: 25px;
    border-top: 2px solid #e9ecef;
}

.failed-question .question-text {
    margin-bottom: 20px;
    font-weight: bold;
    color: #2d3436;
    font-size: 1.2rem;
}

/* ===== Di√°logo de test guardado ===== */
#resumeDialog {
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    right: 0; 
    bottom: 0; 
    background: rgba(0,0,0,0.8); 
    z-index: 9999;
    justify-content: center; 
    align-items: center;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#resumeDialog .card {
    max-width: 500px; 
    background: white;        
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    display: flex; 
    flex-direction: column;
    align-items: center;
    gap: 20px;
    text-align: center;
    animation: slideUp 0.4s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#resumeDialog h2 { 
    margin: 0; 
    font-size: 2rem;
    color: #2d3436;
}

#resumeDialog p { 
    margin: 0; 
    font-size: 1.2rem;
    color: #636e72;
    line-height: 1.6;
}

#resumeDialog button { 
    width: 80%; 
    padding: 18px; 
    font-size: 1.1rem; 
    border-radius: 12px; 
    border: none; 
    cursor: pointer; 
    transition: all 0.3s ease;
    font-weight: bold;
}

#resumeDialog button#continueBtn { 
    background: linear-gradient(135deg, #4ecdc4, #45b7d1);
    color: white; 
}

#resumeDialog button#continueBtn:hover { 
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(78, 205, 196, 0.3);
}

#resumeDialog button#newBtn { 
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: white; 
}

#resumeDialog button#newBtn:hover { 
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
}

#resumeDialog button + button { 
    margin-top: 10px; 
}

/* Responsive */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .card {
        padding: 25px;
    }
    
    h1 {
        font-size: 2rem;
    }
    
    h2 {
        font-size: 1.8rem;
    }
    
    .question {
        font-size: 1.1rem;
    }
    
    .options label {
        padding: 15px 20px;
        font-size: 1rem;
    }
    
    button {
        padding: 16px 20px;
        font-size: 1rem;
    }
    
    #prevBtn, #nextBtn {
        width: 48%;
        padding: 16px;
    }
}
</style>
</head>
<body>
<div class="container">

    <!-- Di√°logo para continuar test guardado -->
    <div id="resumeDialog">
        <div class="card">
            <h2>üíæ Test guardado</h2>
            <p>Se detect√≥ un test previo guardado. ¬øDeseas continuar o empezar uno nuevo?</p>
            <button id="continueBtn">Continuar</button>
            <button id="newBtn">Empezar de nuevo</button>
        </div>
    </div>

    <!-- Pantalla de cuestionario -->
    <div class="card" id="quizCard">
        <h1 id="themeTitle"></h1>
        <div class="info">
            <div id="progress"></div>
            <div id="timer">‚è± 00:00</div>
        </div>
        <div class="question" id="questionText"></div>
        <div class="options" id="options"></div>
        <div class="button-container">
            <button id="prevBtn">Anterior</button>
            <button id="nextBtn">Siguiente</button>
        </div>
    </div>

    <!-- Pantalla final -->
    <div class="card final" id="finalScreen">
        <h2>üìä Resultado final</h2>
        <p id="summary"></p>
        <p id="finalTime"></p>
        <p id="finalNote"></p>
        <div id="failedContainer" style="display:none;"></div>
        <button class="secondary" id="restartBtn">Repetir test</button>
    </div>

</div>

<script>
// === Preguntas ===
const themes = [
{
  "name": "Tema 11",
  "questions": [
  {
    "question": "Las industrias qu√≠micas, aunque es improbable, pueden sufrir accidentes, los cuales se pueden agrupar en : Incendios, explosiones y fugas t√≥xicas. Las explosiones‚Ä¶",
    "options": [
      "Reacciones producidas a gran velocidad, con expansi√≥n muy violenta de gases, cuyo efecto principal es la generaci√≥n de ondas de presi√≥n, que pueden destruir estructuras cercanas. En el exterior pueden producirse rotura de cristales y da√±os estructurales de gran magnitud.",
      "Reacciones producidas a gran velocidad, con expansi√≥n muy violenta de gases, cuyo efecto principal es la generaci√≥n de ondas de presi√≥n, que pueden destruir estructuras cercanas. En el exterior pueden producirse rotura de cristales y da√±os estructurales de peque√±a magnitud. ",
      "Reacciones producidas a gran velocidad, con expansi√≥n muy violenta de gases, cuyo efecto principal es la generaci√≥n de ondas de presi√≥n y nubes t√≥xicas, que pueden destruir estructuras cercanas. En el exterior pueden producirse rotura de cristales y da√±os estructurales de peque√±a magnitud.",
      "Reacciones producidas a gran velocidad, con expansi√≥n muy violenta de gases, cuyo efecto principal es la generaci√≥n de ondas de presi√≥n y nubes t√≥xicas, que pueden destruir estructuras cercanas. En el exterior pueden producirse rotura de cristales y da√±os estructurales de gran magnitud."
    ],
    "answer": "Reacciones producidas a gran velocidad, con expansi√≥n muy violenta de gases, cuyo efecto principal es la generaci√≥n de ondas de presi√≥n, que pueden destruir estructuras cercanas. En el exterior pueden producirse rotura de cristales y da√±os estructurales de peque√±a magnitud. "
  },
  {
    "question": "Estos accidentes tambi√©n se pueden dar... (NIP73850)",
    "options": [
      "Durante la producci√≥n de MMPP en carreteras, ferrocarriles,..",
      "Durante la manipulaci√≥n de MMPP en carretera, ferrocarril,..",
      "Durante el almacenamiento de MMPP en carreteras, ferrocarriles,..",
      "Durante el transporte de MMPP por carretera, ferrocarril,.. "
    ],
    "answer": "Durante el transporte de MMPP por carretera, ferrocarril,.. "
  },
  {
    "question": "La gravedad de una intoxicaci√≥n por v√≠a inhalatoria depender√° fundamentalmente de‚Ä¶ (Se√±ale la incorrectA.",
    "options": [
      "Caracts. t√≥xicas de la sustancia.",
      "Grado de concentraci√≥n de la sustancia.",
      "Tiempo de exposici√≥n.",
      "Factores colectivos. "
    ],
    "answer": "Factores colectivos. "
  },
  {
    "question": "Se√±ale la correcta.",
    "options": [
      "Las √°reas que queden en contra del viento, se ver√°n afectadas por la nube t√≥xica y el grado de afectaci√≥n depender√° del producto, la concentraci√≥n, la distancia, y el tiempo de exposici√≥n.",
      "Las √°reas que queden a favor del viento, se ver√°n afectadas por la nube t√≥xica y el grado de afectaci√≥n depender√° del producto, la concentraci√≥n, la distancia, y el tiempo de exposici√≥n. ",
      "Las √°reas que queden en contra del viento, se ver√°n afectadas por la nube t√≥xica y el grado de afectaci√≥n depender√° del producto, la distancia, y el tiempo de exposici√≥n.",
      "Las √°reas que queden a favor del viento, se ver√°n afectadas por la nube t√≥xica y el grado de afectaci√≥n depender√° del producto, la distancia, y el tiempo de exposici√≥n."
    ],
    "answer": "Las √°reas que queden a favor del viento, se ver√°n afectadas por la nube t√≥xica y el grado de afectaci√≥n depender√° del producto, la concentraci√≥n, la distancia, y el tiempo de exposici√≥n. "
  },
  {
    "question": "En las intoxicaciones por gases se distinguen dos grupos, gases irritantes y gases no irritantes. Los gases irritantes....",
    "options": [
      "Son t√≥xicos a bajas concentraciones. Se caracterizan por producir extensas y profundas lesiones en las mucosas de la v√≠a a√©rea. El nivel de lesi√≥n depender√° de la intensidad y duraci√≥n de la exposici√≥n, as√≠ como del grado de hidrosolubilidad.",
      "Son t√≥xicos a bajas concentraciones. Se caracterizan por producir extensas y profundas lesiones en las mucosas de la v√≠a a√©rea. El nivel de lesi√≥n depender√° de la intensidad y duraci√≥n de la exposici√≥n, as√≠ como del tama√±o de las part√≠culas y grado de hidrosolubilidad. ",
      "Son t√≥xicos a altas concentraciones. Se caracterizan por producir extensas y profundas lesiones en las mucosas de la v√≠a a√©rea. El nivel de lesi√≥n depender√° de la intensidad y duraci√≥n de la exposici√≥n, as√≠ como del grado de hidrosolubilidad.",
      "Son t√≥xicos a altas concentraciones. Se caracterizan por producir extensas y profundas lesiones en las mucosas de la v√≠a a√©rea. El nivel de lesi√≥n depender√° de la intensidad y duraci√≥n de la exposici√≥n, as√≠ como del tama√±o de las part√≠culas y grado de hidrosolubilidad."
    ],
    "answer": "Son t√≥xicos a bajas concentraciones. Se caracterizan por producir extensas y profundas lesiones en las mucosas de la v√≠a a√©rea. El nivel de lesi√≥n depender√° de la intensidad y duraci√≥n de la exposici√≥n, as√≠ como del tama√±o de las part√≠culas y grado de hidrosolubilidad. "
  },
  {
    "question": "En cuanto a los gases irritantes, aquellos gases poco hidrosolubles y con part√≠culas peque√±as, producir√°n el efecto en‚Ä¶",
    "options": [
      "En la v√≠a a√©rea superior.",
      "En bronquios terminales.",
      "En alveolos.",
      "En bronquios terminales y en alveolos. "
    ],
    "answer": "En bronquios terminales y en alveolos. "
  },
  {
    "question": "El sulfuro de hidr√≥geno...",
    "options": [
      "Es un gas no irritante.",
      "Es un gas irritante de acci√≥n irritante intensa. ",
      "Es un gas irritante de acci√≥n irritante moderada.",
      "Es un gas irritante de acci√≥n irritante leve."
    ],
    "answer": "Es un gas irritante de acci√≥n irritante intensa. "
  },
  {
    "question": "Gas irritante incoloro con olor caracter√≠stico a huevos podridos cuando la concentraci√≥n del mismo en el ambiente es baja. La v√≠a de entrada del t√≥xico es inhalatoria y cut√°nea (piel sanA.. Se produce en fosas s√©ptica, cloacas y minas, pero tambi√©n es de uso industrial (Fabricaci√≥n de papel, colas,...)",
    "options": [
      "Sulfuro de hidr√≥geno. ",
      "Fluoruro de hidr√≥geno.",
      "Cloruro de hidr√≥geno.",
      "Di√≥xido de azufre."
    ],
    "answer": "Sulfuro de hidr√≥geno. "
  },
  {
    "question": "Los gases de acci√≥n irritante severa tienen como s√≠ntomas‚Ä¶ (Se√±ale la incorrectA.",
    "options": [
      "Lagrimeo.",
      "Efectos locales inmediatos sobre las mucosas de la v√≠a a√©rea baja. ",
      "Tos seca irritativa.",
      "Aumento mucosidad nasal."
    ],
    "answer": "Efectos locales inmediatos sobre las mucosas de la v√≠a a√©rea baja. "
  },
  {
    "question": "La aparici√≥n de edema pulmonar con un per√≠odo de latencia que, a veces es superior a las 24 horas, es s√≠ntoma caracter√≠stico de...",
    "options": [
      "Gases de acci√≥n irritante moderada.",
      "Gases de acci√≥n irritante leve.",
      "Gases de acci√≥n irritante intensa.",
      "Gases de acci√≥n irritante moderada o leve. "
    ],
    "answer": "Gases de acci√≥n irritante moderada o leve. "
  },
  {
    "question": "El nivel de lesi√≥n de los gases irritantes depender√° de...",
    "options": [
      "Grado de concentraci√≥n, tiempo de exposici√≥n, tama√±o de las part√≠culas y grado de hidrosolubilidad. ",
      "Grado de concentraci√≥n, tiempo de exposici√≥n, tama√±o de las part√≠culas, grado de hidrosolubilidad y los factores individuales.",
      "El tipo de producto, grado de concentraci√≥n, tiempo de exposici√≥n, distancia.",
      "El tipo de producto, grado de concentraci√≥n, tiempo de exposici√≥n y los factores individuales."
    ],
    "answer": "Grado de concentraci√≥n, tiempo de exposici√≥n, tama√±o de las part√≠culas y grado de hidrosolubilidad. "
  },
  {
    "question": "El √°cido clorh√≠drico est√° dentro de...",
    "options": [
      "Gases irritantes de acci√≥n irritante intensa. ",
      "Gases irritantes de acci√≥n irritante moderada.",
      "Gases irritantes de acci√≥n irritante leve.",
      "Gases no irritantes. 13- Los gases irritantes son t√≥xicos a bajas concentraciones: (AUTOEVALUACI√ìN)",
      "Verdadero ",
      "Falso"
    ],
    "answer": "Gases irritantes de acci√≥n irritante intensa. "
  },
  {
    "question": "Toda v√≠ctima de incendios, que presente disminuci√≥n del nivel de consciencia, debe ser considerada v√≠ctima traum√°tica. (AUTOEVALUACI√ìN)",
    "options": [
      "Verdadero ",
      "Falso"
    ],
    "answer": "Verdadero "
  },
  {
    "question": "Gases no irritantes:",
    "options": [
      "Sin acci√≥n local, se absorben hacia la sangre ejerciendo su efecto a nivel sist√©mico e interfiriendo en la cadena respiratoria tisular, provocando hipoxia o desplazando el ox√≠geno del aire expirado.",
      "Sin acci√≥n local, no se absorben hacia la sangre ejerciendo su efecto a nivel sist√©mico o interfiriendo en la cadena respiratoria tisular, provocando hipoxia o desplazando el ox√≠geno del aire inspirado.",
      "Sin acci√≥n local, se absorben hacia la sangre ejerciendo su efecto a nivel sist√©mico o interfiriendo en la cadena respiratoria tisular, provocando hipoxia o desplazando el ox√≠geno del aire inspirado. ",
      "Con acci√≥n local, se absorben hacia la sangre ejerciendo su efecto a nivel sist√©mico o interfiriendo en la cadena respiratoria tisular, provocando hipoxia o desplazando el ox√≠geno del aire inspirado."
    ],
    "answer": "Sin acci√≥n local, se absorben hacia la sangre ejerciendo su efecto a nivel sist√©mico o interfiriendo en la cadena respiratoria tisular, provocando hipoxia o desplazando el ox√≠geno del aire inspirado. "
  },
  {
    "question": "Los gases asfixiantes simples:",
    "options": [
      "Gases fisiol√≥gicamente inertes (no envenenan), pero con efectos dependientes de la concentraci√≥n que alcancen en el aire que respira la v√≠ctima porque, a mayor concentraci√≥n, habr√° menos ox√≠geno ( desplazan al ox√≠geno del aire inspirado). ",
      "Gases fisiol√≥gicamente inertes (envenenan), pero con efectos dependientes de la concentraci√≥n que alcancen en el aire que respira la v√≠ctima porque, a menor concentraci√≥n, habr√° menos ox√≠geno ( desplazan al ox√≠geno del aire inspirado).",
      "Gases fisiol√≥gicamente inertes (no envenenan), pero con efectos dependientes de la concentraci√≥n que alcancen en el aire que respira la v√≠ctima porque, a mayor concentraci√≥n, habr√° menos ox√≠geno ( desplazan al ox√≠geno del aire expirado).",
      "Gases fisiol√≥gicamente inertes (no envenenan), pero con efectos dependientes de la concentraci√≥n que alcancen en el aire que respira la v√≠ctima porque, a mayor concentraci√≥n, habr√° m√°s ox√≠geno ( desplazan al ox√≠geno del aire inspirado)."
    ],
    "answer": "Gases fisiol√≥gicamente inertes (no envenenan), pero con efectos dependientes de la concentraci√≥n que alcancen en el aire que respira la v√≠ctima porque, a mayor concentraci√≥n, habr√° menos ox√≠geno ( desplazan al ox√≠geno del aire inspirado). "
  },
  {
    "question": "Gases asfixiantes celulares:",
    "options": [
      "Provocan un s√≠ndrome asfixiante por hipoxia.",
      "Producen d√©ficit de ox√≠geno en los tejidos.",
      "Producen alteraciones del SNC y cardiovasculares.",
      "Todas las anteriores. "
    ],
    "answer": "Todas las anteriores. "
  },
  {
    "question": "Gas inodoro e incoloro que se genera durante la combusti√≥n incompleta, con poco ox√≠geno de cualquier combustible con carbono, es:",
    "options": [
      "Sulfuro de hidr√≥geno.",
      "Mon√≥xido de carbono. ",
      "Cianuro de hidr√≥geno.",
      "Ninguna de las anteriores."
    ],
    "answer": "Mon√≥xido de carbono. "
  },
  {
    "question": "El cianuro de hidr√≥geno se produce en condiciones similares a las del:",
    "options": [
      "Sulfuro de hidr√≥geno.",
      "Cloruro de metileno.",
      "Metano.",
      "Mon√≥xido de carbono. "
    ],
    "answer": "Mon√≥xido de carbono. "
  },
  {
    "question": "Las personas intoxicadas por CO suelen presentar inicialmente:",
    "options": [
      "Mareo.",
      "Dolor de cabeza.",
      "Dificultad respiratoria",
      "Todas las anteriores. "
    ],
    "answer": "Todas las anteriores. "
  },
  {
    "question": "Por v√≠a inhalatoria, adem√°s de las intoxicaciones por gases, se pueden dar otras producidas por la absorci√≥n de:",
    "options": [
      "Vapores procedentes de disolventes inorg√°nicos.",
      "Mon√≥xido de carbono.",
      "Vapores procedentes de disolventes org√°nicos. ",
      "Part√≠culas s√≥lidas."
    ],
    "answer": "Vapores procedentes de disolventes org√°nicos. "
  },
  {
    "question": "¬øDe cu√°l de estas opciones NO depende la composici√≥n del humo?",
    "options": [
      "De los materiales que se est√©n quemando.",
      "De las part√≠culas s√≥lidas que lo forman.",
      "Riqueza de O2 en el ambiente.",
      "Temperatura de la combusti√≥n. "
    ],
    "answer": "Temperatura de la combusti√≥n. "
  },
  {
    "question": "En caso de inhalaci√≥n de humos y gases: la PLS solamente se utilizar√° si hay m√∫ltiples v√≠ctimas o si es estrictamente necesario",
    "options": [
      "Verdadero. ",
      "Falso."
    ],
    "answer": "Verdadero. "
  },
  {
    "question": "La atenci√≥n inicial de v√≠ctimas en casos de inhalaci√≥n de humos y gases consiste en: (se√±ala la INCORRECTA.",
    "options": [
      "Alejar a la v√≠ctima de la fuente de envenenamiento.",
      "Realizar valoraci√≥n primaria y secundaria.",
      "Si est√° en PCR, realizar maniobras de RCP b√°sicas habituales.",
      "Administrar ox√≠geno a flujo medio a todos los pacientes. "
    ],
    "answer": "Administrar ox√≠geno a flujo medio a todos los pacientes. "
  }
]
},
]

// === Variables ===
let theme = themes[0];
let index=0, correct=0, incorrect=0, startTime=Date.now(), answers=[], timerInterval;

// === DOM ===
const themeTitle = document.getElementById("themeTitle");
const questionText = document.getElementById("questionText");
const optionsDiv = document.getElementById("options");
const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");
const progress = document.getElementById("progress");
const timer = document.getElementById("timer");

const quizCard = document.getElementById("quizCard");
const finalScreen = document.getElementById("finalScreen");
const summary = document.getElementById("summary");
const finalTime = document.getElementById("finalTime");
const finalNote = document.getElementById("finalNote");
const failedContainer = document.getElementById("failedContainer");

const resumeDialog = document.getElementById("resumeDialog");
const continueBtn = document.getElementById("continueBtn");
const newBtn = document.getElementById("newBtn");
const restartBtn = document.getElementById("restartBtn");

// === Funciones ===
function initTest(loadSaved=false){
    const saved = localStorage.getItem("testState");
    if(!loadSaved && saved){
        resumeDialog.style.display="flex";
        quizCard.style.display="none";
        finalScreen.style.display="none";
        return;
    }

    resumeDialog.style.display="none";
    quizCard.style.display="block";
    finalScreen.style.display="none";

    if(loadSaved && saved){
        const state = JSON.parse(saved);
        index=state.index; correct=state.correct; incorrect=state.incorrect;
        startTime=state.startTime; answers=state.answers;
    }else{
        index=0; correct=0; incorrect=0; startTime=Date.now(); answers=[];
        localStorage.removeItem("testState");
    }

    themeTitle.textContent = theme.name;
    clearInterval(timerInterval);
    timerInterval=setInterval(updateTimer,1000);
    loadQuestion();
}

function loadQuestion(){
    const q = theme.questions[index];
    questionText.textContent=q.question;
    optionsDiv.innerHTML="";
    progress.textContent=`Pregunta ${index+1} / ${theme.questions.length}`;

    q.options.forEach(opt=>{
        const label=document.createElement("label");
        label.textContent=opt;
        if(answers[index]?.selected===opt) label.classList.add("selected");
        label.addEventListener("click",()=>{
            document.querySelectorAll(".options label").forEach(l=>l.classList.remove("selected"));
            label.classList.add("selected");
            answers[index]={question:q.question, options:q.options, correct:q.answer, selected:opt, number:index+1};
            saveProgress();
        });
        optionsDiv.appendChild(label);
    });

    prevBtn.style.display = index===0 ? "none" : "inline-block";
    nextBtn.textContent = index===theme.questions.length-1 ? "Finalizar" : "Siguiente";
}

function saveProgress(){
    localStorage.setItem("testState", JSON.stringify({index, correct, incorrect, startTime, answers}));
}

nextBtn.addEventListener("click", ()=>{
    const selectedAnswer = answers[index]?.selected || null; // null si no respondi√≥
    const q = theme.questions[index];

    answers[index] = { question:q.question, options:q.options, correct:q.answer, selected:selectedAnswer, number:index+1 };
    saveProgress();

    if(selectedAnswer){
        if(selectedAnswer === q.answer) correct++;
        else incorrect++;
    }

    if(index < theme.questions.length-1){ index++; loadQuestion();}
    else finishTest();
});

prevBtn.addEventListener("click", ()=>{
    if(index>0) index--; loadQuestion();
});

function finishTest(){
    clearInterval(timerInterval);
    localStorage.removeItem("testState");
    quizCard.style.display="none";
    finalScreen.style.display="block";

    const totalSeconds = Math.floor((Date.now()-startTime)/1000);
    const min = String(Math.floor(totalSeconds/60)).padStart(2,"0");
    const sec = String(totalSeconds %60).padStart(2,"0");
    const rawScore = correct - (incorrect/3);
    const note = Math.max(0,(rawScore/theme.questions.length)*10).toFixed(2);

    summary.innerHTML=`‚úîÔ∏è Correctas: <strong>${correct}</strong><br>‚ùå Incorrectas: <strong>${incorrect}</strong>`;
    finalTime.textContent=`‚è± Tiempo total: ${min}:${sec}`;
    finalNote.innerHTML=`üéØ Nota final: <strong style="font-size: 2rem; color: #667eea;">${note}/10</strong>`;

    failedContainer.style.display="block";
    failedContainer.innerHTML = "";

    // Preguntas incorrectas
    const failed = answers.filter(a=>a.selected && a.selected!==a.correct);
    if(failed.length){
        const failedDiv = document.createElement("div");
        failedDiv.innerHTML = "<h3 style='color: #ff6b6b; margin-bottom: 20px;'>üìù Preguntas incorrectas</h3>";
        failed.forEach(a=>{
            const div=document.createElement("div"); div.className="failed-question";
            div.innerHTML=`<div class="question-text">Pregunta ${a.number}: ${a.question}</div>`;
            const opts=document.createElement("div"); opts.className="options";
            a.options.forEach(opt=>{
                const label=document.createElement("label");
                if(opt===a.correct) label.classList.add("option-correct");
                if(opt===a.selected) label.classList.add("option-wrong");
                label.textContent=opt;
                opts.appendChild(label);
            });
            div.appendChild(opts);
            failedDiv.appendChild(div);
        });
        failedContainer.appendChild(failedDiv);
    }

    // Preguntas no respondidas
    const unanswered = answers.filter(a=>a.selected===null);
    if(unanswered.length){
        const unDiv = document.createElement("div");
        unDiv.innerHTML="<h3 style='color: #636e72; margin-bottom: 20px;'>‚ùì Preguntas no respondidas</h3>";
        unanswered.forEach(a=>{
            const div=document.createElement("div"); div.className="failed-question";
            div.innerHTML=`<div class="question-text">Pregunta ${a.number}: ${a.question}</div>`;
            const opts=document.createElement("div"); opts.className="options";
            a.options.forEach(opt=>{
                const label=document.createElement("label");
                if(opt===a.correct) label.classList.add("option-correct");
                label.textContent=opt;
                opts.appendChild(label);
            });
            div.appendChild(opts);
            unDiv.appendChild(div);
        });
        failedContainer.appendChild(unDiv);
    }
}

function updateTimer(){
    const elapsed = Math.floor((Date.now()-startTime)/1000);
    const m = String(Math.floor(elapsed/60)).padStart(2,"0");
    const s = String(elapsed%60).padStart(2,"0");
    timer.textContent=`‚è± ${m}:${s}`;
}

function restartTest(){
    correct=0; incorrect=0; index=0; answers=[]; startTime=Date.now();
    localStorage.removeItem("testState");
    initTest(false);
}

// === Botones ===
continueBtn.addEventListener("click", ()=>initTest(true));
newBtn.addEventListener("click", ()=>restartTest());
restartBtn.addEventListener("click", ()=>restartTest());

// A√±adir bot√≥n de volver al inicio
const backButton = document.createElement("button");
backButton.textContent = "Volver al inicio";
backButton.style.background = "linear-gradient(135deg, #ff6b6b, #ee5a52)";
backButton.style.marginTop = "20px";
backButton.addEventListener("click", () => {
    window.location.href = "../index.html";
});
document.getElementById("finalScreen").appendChild(backButton);

initTest();
</script>
</body>
</html>